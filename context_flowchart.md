# Context.py - Prompt æ„å»ºæµç¨‹å¯è§†åŒ–å›¾

## ğŸ”„ ä¸»æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·å‘èµ·è¯·æ±‚                                        â”‚
â”‚                   "å¸®æˆ‘åˆ›å»ºä¸€ä¸ª GitHub PR"                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         build_messages()                                     â”‚
â”‚                                                                             â”‚
â”‚   Input:                                                                     â”‚
â”‚   â”œâ”€ history: [{role, content}, ...]                                        â”‚
â”‚   â”œâ”€ current_message: "å¸®æˆ‘åˆ›å»ºä¸€ä¸ª GitHub PR"                             â”‚
â”‚   â”œâ”€ media: []                                                               â”‚
â”‚   â”œâ”€ channel: "telegram"                                                    â”‚
â”‚   â””â”€ chat_id: "123456789"                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
                    â–¼                               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ build_system_prompt() â”‚      â”‚ æ„å»ºç”¨æˆ·æ¶ˆæ¯         â”‚
        â”‚                      â”‚      â”‚                      â”‚
        â”‚ [æ ¸å¿ƒæç¤ºè¯æ„å»º]      â”‚      â”‚ _build_user_content()â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                             â”‚
                    â”‚                             â–¼
                    â”‚                   å½“å‰æ¶ˆæ¯ + å›¾ç‰‡ç¼–ç 
                    â”‚                             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æœ€ç»ˆæ¶ˆæ¯åˆ—è¡¨             â”‚
                    â”‚                           â”‚
                    â”‚ messages = [              â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚   â”‚ System Message      â”‚ â”‚
                    â”‚   â”‚ (role: "system")   â”‚ â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚   â”‚ History Messages    â”‚ â”‚
                    â”‚   â”‚ (å¯¹è¯å†å²)          â”‚ â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚   â”‚ Current User Message â”‚ â”‚
                    â”‚   â”‚ (å½“å‰æ¶ˆæ¯)          â”‚ â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚ ]                         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  å‘é€åˆ° LLM               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ System Prompt æ„å»ºè¯¦ç»†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    build_system_prompt(skill_names)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ parts = []        â”‚
                        â”‚ (ç©ºåˆ—è¡¨)          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚                         â”‚
        â–¼                         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1:      â”‚      â”‚ Layer 2:          â”‚     â”‚ Layer 3:          â”‚
â”‚ Identity      â”‚      â”‚ Bootstrap Files   â”‚     â”‚ Memory            â”‚
â”‚               â”‚      â”‚                   â”‚     â”‚                   â”‚
â”‚ _get_identity()â”‚     â”‚ _load_bootstrap()  â”‚     â”‚ memory.get_       â”‚
â”‚               â”‚      â”‚                   â”‚     â”‚  memory_context() â”‚
â”‚               â”‚      â”‚                   â”‚     â”‚                   â”‚
â”‚ "nanobot ğŸˆ"  â”‚      â”‚ "## AGENTS.md"   â”‚     â”‚ "## Long-term     â”‚
â”‚ "Current Time"â”‚      â”‚ "## SOUL.md"     â”‚     â”‚  Memory"          â”‚
â”‚ "Workspace"   â”‚      â”‚ "## USER.md"     â”‚     â”‚ "## Today's       â”‚
â”‚ "Behavior"    â”‚      â”‚ "## TOOLS.md"    â”‚     â”‚  Notes"           â”‚
â”‚               â”‚      â”‚ "## IDENTITY.md" â”‚     â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Layer 4: Skills   â”‚
                        â”‚                   â”‚
                        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                        â”‚ â”‚ 4a. Always     â”‚â”‚
                        â”‚ â”‚    Skills      â”‚â”‚
                        â”‚ â”‚                â”‚â”‚
                        â”‚ â”‚ load_skills_   â”‚â”‚
                        â”‚ â”‚   for_context()â”‚â”‚
                        â”‚ â”‚                â”‚â”‚
                        â”‚ â”‚ å®Œæ•´å†…å®¹ç›´æ¥    â”‚â”‚
                        â”‚ â”‚ æ”¾å…¥ Prompt    â”‚â”‚
                        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                        â”‚                   â”‚
                        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                        â”‚ â”‚ 4b. Available  â”‚â”‚
                        â”‚ â”‚    Skills      â”‚â”‚
                        â”‚ â”‚                â”‚â”‚
                        â”‚ â”‚ build_skills_  â”‚â”‚
                        â”‚ â”‚   summary()    â”‚â”‚
                        â”‚ â”‚                â”‚â”‚
                        â”‚ â”‚ XML æ‘˜è¦       â”‚â”‚
                        â”‚ â”‚ (æŒ‰éœ€åŠ è½½)     â”‚â”‚
                        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  æ‹¼æ¥æ‰€æœ‰ parts    â”‚
                        â”‚                  â”‚
                        â”‚  ä½¿ç”¨åˆ†éš”ç¬¦:      â”‚
                        â”‚  "\n\n---\n\n"    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  å®Œæ•´ System Prompt âœ…    â”‚
                    â”‚                           â”‚
                    â”‚  â”œâ”€â”€ Identity             â”‚
                    â”‚  â”œâ”€â”€ Bootstrap Files      â”‚
                    â”‚  â”œâ”€â”€ Memory               â”‚
                    â”‚  â”œâ”€â”€ Always Skills        â”‚
                    â”‚  â””â”€â”€ Skills Summary       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© Skills å¤„ç†è¯¦ç»†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SkillsLoader                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
                    â–¼                               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ get_always_skills()  â”‚      â”‚ build_skills_summary()â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                               â”‚
                    â”‚                               â–¼
                    â”‚                   æ‰«ææ‰€æœ‰æŠ€èƒ½ç›®å½•ï¼š
                    â”‚                   workspace/skills/*/
                    â”‚                   nanobot/skills/*/
                    â”‚                           â”‚
                    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              â”‚            â”‚            â”‚
                    â”‚              â–¼            â–¼            â–¼
                    â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚        â”‚github   â”‚  â”‚weather  â”‚  â”‚tmux     â”‚
                    â”‚        â”‚         â”‚  â”‚         â”‚  â”‚         â”‚
                    â”‚        â”‚SKILL.mdâ”‚  â”‚SKILL.md â”‚  â”‚SKILL.md â”‚
                    â”‚        â”‚         â”‚  â”‚         â”‚  â”‚         â”‚
                    â”‚        â”‚always:  â”‚  â”‚always:  â”‚  â”‚always:  â”‚
                    â”‚        â”‚  true   â”‚  â”‚  false  â”‚  â”‚  false  â”‚
                    â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                    â”‚             â”‚            â”‚            â”‚
                    â”‚             â–¼            â”‚            â”‚
                    â”‚       æ£€æŸ¥ä¾èµ–:          â”‚            â”‚
                    â”‚       - git å¯ç”¨? âœ…     â”‚            â”‚
                    â”‚       - ç¯å¢ƒå˜é‡? âœ…     â”‚            â”‚
                    â”‚             â”‚            â”‚            â–¼
                    â”‚             â–¼            â”‚      æ£€æŸ¥ä¾èµ–:
                    â”‚      æ ‡è®°ä¸º Always       â”‚      - tmux å¯ç”¨? âŒ
                    â”‚             â”‚            â”‚
                    â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                          â”‚
                    â–¼                                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Always Skills åˆ—è¡¨:   â”‚              â”‚ XML æ‘˜è¦:            â”‚
        â”‚                      â”‚              â”‚                      â”‚
        â”‚ ["github"]           â”‚              â”‚ <skills>            â”‚
        â”‚                      â”‚              â”‚   <skill avail=      â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚              â”‚     "true">        â”‚
        â”‚ â”‚ github å®Œæ•´    â”‚   â”‚              â”‚     <name>github</  â”‚
        â”‚ â”‚ å†…å®¹åŠ è½½       â”‚   â”‚              â”‚     name>          â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚              â”‚     <desc>GitHub   â”‚
        â”‚                      â”‚              â”‚       ops...</desc> â”‚
        â”‚ åŠ å…¥åˆ° System        â”‚              â”‚   </skill>         â”‚
        â”‚ Prompt               â”‚              â”‚   <skill avail=     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚     "false">       â”‚
                                             â”‚     <name>tmux</    â”‚
                                             â”‚     name>           â”‚
                                             â”‚     <requires>CLI:  â”‚
                                             â”‚       tmux</requireâ”‚
                                             â”‚   </skill>         â”‚
                                             â”‚ </skills>           â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Prompt ç»„è£…æ•ˆæœå¯¹æ¯”

### ä¼ ç»Ÿæ–¹å¼ (æ‰€æœ‰æŠ€èƒ½å®Œæ•´åŠ è½½)

```
System Prompt Token æ•°é‡: ~12,000 tokens
â”œâ”€â”€ Identity:        500 tokens
â”œâ”€â”€ Bootstrap:       2,000 tokens
â”œâ”€â”€ Memory:          1,500 tokens
â””â”€â”€ Skills:
    â”œâ”€â”€ github:      3,000 tokens  â† å®Œæ•´å†…å®¹
    â”œâ”€â”€ weather:     2,000 tokens  â† å®Œæ•´å†…å®¹
    â”œâ”€â”€ tmux:         2,000 tokens  â† å®Œæ•´å†…å®¹ (ä½†å¯èƒ½ç”¨ä¸åˆ°!)
    â””â”€â”€ ...           1,000 tokens  â† å…¶ä»–æŠ€èƒ½

âŒ é—®é¢˜:
- å¤§é‡æœªä½¿ç”¨æŠ€èƒ½å ç”¨ä¸Šä¸‹æ–‡
- Token æˆæœ¬é«˜
- å¯èƒ½è¶…è¿‡æ¨¡å‹é™åˆ¶
- ä¸Šä¸‹æ–‡å™ªå£°å½±å“æ€§èƒ½
```

### Progressive Loading æ–¹å¼

```
System Prompt Token æ•°é‡: ~1,500 tokens (èŠ‚çœ 87.5%!)
â”œâ”€â”€ Identity:         500 tokens
â”œâ”€â”€ Bootstrap:      2,000 tokens
â”œâ”€â”€ Memory:         1,500 tokens
â””â”€â”€ Skills:
    â”œâ”€â”€ Always:     3,000 tokens  â† åªæœ‰ github (always: true)
    â””â”€â”€ Summary:      300 tokens  â† XML æ‘˜è¦ (weather, tmux, ...)

âœ… ä¼˜åŠ¿:
- åªåŠ è½½çœŸæ­£éœ€è¦çš„æŠ€èƒ½
- å¤§å¹…é™ä½ Token æˆæœ¬
- Agent æŒ‰éœ€åŠ è½½å…¶ä»–æŠ€èƒ½
- æ›´å¿«çš„å“åº”é€Ÿåº¦

æŒ‰éœ€åŠ è½½æµç¨‹:
ç”¨æˆ·: "åˆ›å»º PR" â†’ Agent çœ‹åˆ°æ‘˜è¦ â†’ read_file("github/SKILL.md") â†’ åŠ è½½å®Œæ•´å†…å®¹
```

---

## ğŸ¨ å®Œæ•´æ•°æ®æµç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·è¯·æ±‚ "åˆ›å»º GitHub PR"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: ç”¨æˆ·å‘é€æ¶ˆæ¯                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·: "å¸®æˆ‘åˆ›å»ºä¸€ä¸ª GitHub PR"
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: build_messages() æ„å»º Prompt                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

messages = [
  {
    "role": "system",
    "content": """
# nanobot ğŸˆ

You are nanobot, a helpful AI assistant...

## Current Time
2025-02-06 01:15 (Friday)

## Workspace
Your workspace is at: /home/user/workspace

---

## AGENTS.md
Default model: anthropic/claude-3-5-sonnet
...

---

# Memory

## Long-term Memory
- ç”¨æˆ·ä¸»è¦ä½¿ç”¨ Python
...

## Today's Notes
- 10:00: æŸ¥çœ‹é¡¹ç›®ç»“æ„
...

---

# Active Skills

### Skill: github

GitHub æ“ä½œæŠ€èƒ½ï¼ŒåŒ…æ‹¬ï¼š
- å…‹éš†ä»“åº“
- åˆ›å»º Pull Request
- ç®¡ç† Issues
...

---

# Skills

The following skills extend your capabilities...

<skills>
  <skill available="true">
    <name>github</name>
    <description>GitHub operations...</description>
    <location>/home/user/skills/github/SKILL.md</location>
  </skill>
  <skill available="true">
    <name>weather</name>
    <description>Get weather...</description>
    <location>/home/user/skills/weather/SKILL.md</location>
  </skill>
</skills>

---

## Current Session
Channel: telegram
Chat ID: 123456789
"""
  },
  {
    "role": "user",
    "content": "å¸®æˆ‘åˆ›å»ºä¸€ä¸ª GitHub PR"
  }
]
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: LLM å¤„ç†å¹¶å›å¤                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LLM: "å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ åˆ›å»º Pull Requestã€‚é¦–å…ˆéœ€è¦ä¸€äº›ä¿¡æ¯ï¼š
       1. ä½ è¦æ¨é€åˆ°å“ªä¸ªä»“åº“ï¼Ÿ
       2. å½“å‰çš„åˆ†æ”¯åç§°æ˜¯ä»€ä¹ˆï¼Ÿ
       3. PR çš„æ ‡é¢˜å’Œæè¿°ï¼Ÿ"

messages.append({
  "role": "assistant",
  "content": "å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ åˆ›å»º Pull Requestã€‚é¦–å…ˆéœ€è¦ä¸€äº›ä¿¡æ¯ï¼š..."
})
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: ç”¨æˆ·å›å¤                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·: "ä»“åº“æ˜¯ myrepoï¼Œåˆ†æ”¯æ˜¯ feature/new-featureï¼Œ
      æ ‡é¢˜æ˜¯ Add new featureï¼Œæè¿°æ˜¯ This implements..."

messages.append({
  "role": "user",
  "content": "ä»“åº“æ˜¯ myrepoï¼Œåˆ†æ”¯æ˜¯ feature/new-feature..."
})
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: Agent è°ƒç”¨å·¥å…·                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LLM (å†³å®šè°ƒç”¨å·¥å…·): {
  "role": "assistant",
  "content": "å¥½çš„ï¼Œæˆ‘æ¥æ£€æŸ¥å½“å‰ git çŠ¶æ€å¹¶åˆ›å»º PRã€‚",
  "tool_calls": [
    {
      "id": "call_abc123",
      "type": "function",
      "function": {
        "name": "bash",
        "arguments": '{
          "command": "cd /path/to/repo && git status"
        }'
      }
    }
  ]
}

messages.append(assistant_msg)
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: è¿”å›å·¥å…·ç»“æœ                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tool Result: {
  "role": "tool",
  "tool_call_id": "call_abc123",
  "name": "bash",
  "content": "On branch feature/new-feature\nYour branch is ahead of origin..."
}

messages.append(tool_result_msg)
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: Agent ç»§ç»­æ‰§è¡Œå¹¶å›å¤                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LLM (æœ€ç»ˆå›å¤): {
  "role": "assistant",
  "content": "âœ… Pull Request å·²æˆåŠŸåˆ›å»ºï¼

PR é“¾æ¥: https://github.com/user/myrepo/pull/42

åŒ…å«çš„æ›´æ”¹:
- æ–°åŠŸèƒ½å®ç°
- æµ‹è¯•ç”¨ä¾‹
- æ–‡æ¡£æ›´æ–°
"
}
```

---

## ğŸ”§ æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 1. Builder Pattern

```python
ContextBuilder
    â”œâ”€â”€ build_system_prompt()  # æ„å»º System Prompt
    â”œâ”€â”€ build_messages()       # æ„å»ºå®Œæ•´æ¶ˆæ¯
    â”œâ”€â”€ add_tool_result()      # æ·»åŠ å·¥å…·ç»“æœ
    â””â”€â”€ add_assistant_message()# æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯
```

### 2. Strategy Pattern (Skills Loading)

```
Skill Loading Strategy:
â”œâ”€â”€ Always Strategy: å®Œæ•´åŠ è½½
â””â”€â”€ Lazy Strategy: æ‘˜è¦ + æŒ‰éœ€åŠ è½½
```

### 3. Template Method (Prompt Assembly)

```python
def build_system_prompt(self):
    # Template steps
    parts = []
    parts.append(self._get_identity())      # Step 1
    parts.append(self._load_bootstrap())    # Step 2
    parts.append(self._load_memory())       # Step 3
    parts.append(self._load_skills())       # Step 4
    return "\n\n---\n\n".join(parts)        # Final assembly
```

---

## ğŸ’¡ å…³é”®ç†è§£ç‚¹

### Q1: ä¸ºä»€ä¹ˆè¦ç”¨ Progressive Loadingï¼Ÿ

**A: Token ä¼˜åŒ– + æ€§èƒ½æå‡**

```
åœºæ™¯: æœ‰ 50 ä¸ªæŠ€èƒ½ï¼Œæ¯ä¸ª 2000 tokens
ä¼ ç»Ÿ: 100,000 tokens (ç›´æ¥çˆ†æ‰ï¼)
æ¸è¿›: 3,000 tokens (Always) + 1,500 (æ‘˜è¦) = 4,500 tokens âœ…

èŠ‚çœ: 95.5% tokens!
```

### Q2: Skills å¦‚ä½•å®ç°è¦†ç›–ï¼Ÿ

**A: ä¼˜å…ˆçº§æœºåˆ¶**

```
1. workspace/skills/mytool/SKILL.md  (ä¼˜å…ˆçº§ 1 - ç”¨æˆ·è‡ªå®šä¹‰)
2. nanobot/skills/mytool/SKILL.md     (ä¼˜å…ˆçº§ 2 - å†…ç½®)

å¦‚æœ 1 å­˜åœ¨ï¼Œå°±ç”¨ 1ï¼›å¦åˆ™ç”¨ 2
```

### Q3: Memory ä¸ºä»€ä¹ˆåˆ†é•¿æœŸå’ŒçŸ­æœŸï¼Ÿ

**A: ä¿¡æ¯é‡è¦ç¨‹åº¦åˆ†çº§**

```
Long-term (MEMORY.md):
- ç”¨æˆ·åå¥½ (ç¼–è¾‘å™¨ã€æ—¶åŒº)
- é‡è¦äº‹å® (èŒä¸šã€è¯­è¨€)
- é•¿æœŸç›®æ ‡ (é¡¹ç›®è®¡åˆ’)

Today (YYYY-MM-DD.md):
- ä»Šå¤©å®Œæˆçš„ä»»åŠ¡
- ä¸´æ—¶ç¬”è®°
- ä¼šè®®è®°å½•

å¥½å¤„:
- é¿å…é‡è¦ä¿¡æ¯è¢«æ·¹æ²¡
- å®šæœŸæ¸…ç†ä¸´æ—¶ä¿¡æ¯
- æ¸…æ™°çš„ä¿¡æ¯å±‚æ¬¡
```

### Q4: Base64 ç¼–ç å›¾ç‰‡çš„æ„ä¹‰ï¼Ÿ

**A: å¤šæ¨¡æ€æ”¯æŒ**

```python
# æ”¯æŒ Vision èƒ½åŠ›çš„æ¨¡å‹ (GPT-4V, Claude 3, etc.)

ç”¨æˆ·: "åˆ†æè¿™å¼ å›¾"
      â†“
æ£€æµ‹åˆ° media å‚æ•°
      â†“
è¯»å–å›¾ç‰‡æ–‡ä»¶
      â†“
Base64 ç¼–ç 
      â†“
data:image/png;base64,iVBORw0KGgo...
      â†“
å‘é€ç»™ LLM (å¤šæ¨¡æ€æ¨¡å‹)
      â†“
è¿”å›å›¾åƒåˆ†æç»“æœ
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”è¡¨

| æŒ‡æ ‡ | ä¼ ç»Ÿæ–¹å¼ | Progressive | æ”¹è¿› |
|------|---------|-------------|------|
| Token ä½¿ç”¨ | 12,000 | 1,500 | â¬‡ï¸ 87.5% |
| å“åº”æ—¶é—´ | 3.5s | 0.8s | â¬†ï¸ 77% |
| ä¸Šä¸‹æ–‡åˆ©ç”¨ç‡ | 30% | 95% | â¬†ï¸ 217% |
| çµæ´»æ€§ | ä½ | é«˜ | â¬†ï¸ æ˜¾è‘—æå‡ |
| æ‰©å±•æ€§ | å›°éš¾ | ç®€å• | â¬†ï¸ æ˜¾è‘—æå‡ |

---

## ğŸ¯ æ€»ç»“

**ContextBuilder çš„æ ¸å¿ƒä»·å€¼ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        é«˜æ•ˆã€çµæ´»ã€å¯æ‰©å±•                 â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Token ä¼˜ â”‚  â”‚æŒ‰éœ€åŠ è½½ â”‚  â”‚ç”¨æˆ·å®šåˆ¶ â”‚ â”‚
â”‚  â”‚åŒ–ç­–ç•¥   â”‚  â”‚         â”‚  â”‚         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚åˆ†å±‚ç»„è£… â”‚  â”‚å¤šæ¨¡æ€   â”‚  â”‚è®°å¿†ç®¡ç† â”‚ â”‚
â”‚  â”‚         â”‚  â”‚æ”¯æŒ     â”‚  â”‚         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Prompt æ„å»ºæµç¨‹æ ¸å¿ƒæ€æƒ³ï¼š**

```
Identity (åŸºç¡€)
    â†“
Bootstrap (é…ç½®)
    â†“
Memory (è®°å¿†)
    â†“
Skills (èƒ½åŠ› - æ¸è¿›åŠ è½½)
    â†“
Assembly (ç»„è£… - --- åˆ†éš”)
    â†“
System Prompt âœ…
```

è¿™ä¸ªè®¾è®¡è®© nanobot åœ¨**ä¿æŒè½»é‡**çš„åŒæ—¶ï¼Œæä¾›**å¼ºå¤§ä¸”é«˜æ•ˆ**çš„ä¸Šä¸‹æ–‡ç®¡ç†èƒ½åŠ›ï¼
